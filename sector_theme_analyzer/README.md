# Sector Theme Analyzer (V3)

업종 + 테마 동시 상승 종목 분석 도구

## 개요

과거 날짜 기준으로 **업종**과 **테마**가 동시에 X일 평균 상승한 종목을 찾는 프로그램입니다.
백테스팅 및 시뮬레이션 용도로 활용할 수 있습니다.

### 기존 버전(consecutive_rise_finder)과의 차이점

| 항목 | consecutive_rise_finder | sector_theme_analyzer (V3) |
|------|------------------------|---------------------------|
| 테마 API | t1533 (오늘만 조회 가능) | t8410 (과거 날짜 지정 가능) |
| 테마 그룹핑 | API 조회 | JSON 섹터코드 기반 |
| 과거 조회 | 업종만 가능 | 업종 + 테마 모두 가능 |
| 용도 | 실시간 투자 | 과거 데이터 시뮬레이션 |

---

## 상승 판정 로직

### 1. 업종 상승 판정
- t1514 API로 업종별 X일 기간 데이터 조회
- **X일 평균 등락률 > 0** 이면 상승 업종으로 판정
- 분석 대상: 업종코드 005~030 (실제 산업분류)

### 2. 테마 상승 판정
- JSON 파일의 `섹터코드`로 테마별 종목 그룹핑
- t8410 API로 각 종목의 X일 일봉 데이터 조회
- 조건:
  - 테마 내 종목 중 **60% 이상**이 평균 등락률 양수
  - 테마 전체 **평균 등락률 > 0**

### 3. 종목 매칭
- 종목의 `업종코드`가 상승 업종에 포함
- 종목의 `섹터코드`가 상승 테마에 포함
- 두 조건을 **모두** 만족하는 종목 추출

---

## 파일 구조

```
sector_theme_analyzer/
├── __init__.py              # 패키지 초기화
├── config.py                # 설정 (API 키, 파라미터)
├── ls_api_client.py         # LS증권 API 클라이언트
├── sector_analyzer.py       # 업종 상승 분석
├── theme_analyzer.py        # 테마 상승 분석
├── stock_matcher.py         # 종목 매칭
├── main.py                  # 메인 실행 (API 기반)
├── local_analyzer.py        # 로컬 데이터 기반 분석 (빠름)
├── simulate.py              # 비율 시뮬레이션 (API 호출 없음)
├── download_ohlc.py         # OHLC 데이터 다운로드
├── convert_to_parquet.py    # CSV → Parquet 변환
├── README.md                # 이 문서
└── output/                  # 결과 저장 폴더
```

---

## 실행 방법

### 1. 로컬 데이터 기반 분석 (권장)

**API 호출 없이** Parquet 데이터만으로 분석합니다. 기존 API 기반 대비 **수백 배 빠릅니다**.

```bash
cd sector_theme_analyzer

# 기본 실행 (5일 평균 상승, 섹터 60% 기준)
python local_analyzer.py --base-date 20251105 --days 5

# 3일 평균 상승
python local_analyzer.py --base-date 20251105 --days 3

# 섹터 상승 비율 70%로 변경
python local_analyzer.py --base-date 20251105 --days 5 --ratio 0.7

# 특정 Parquet 파일 사용
python local_analyzer.py --base-date 20251105 --parquet ohlc_xxx.parquet
```

#### 속도 비교

| 방식 | 소요 시간 |
|------|----------|
| API 기반 (main.py) | 40~50분 |
| **로컬 기반 (local_analyzer.py)** | **2~3초** |

#### 출력 예시

```
============================================================
   LOCAL ANALYZER
   로컬 데이터 기반 업종 + 섹터 동시 상승 종목 분석
============================================================
   기준일: 20251105
   분석 기간: 5일
   섹터 상승 비율: 60%
============================================================

   [LOAD] 데이터 로드 중...
   -> Parquet: ohlc_20241209_20251205_30m.parquet
      6,675,446행, 2163종목
   -> JSON: 4212종목

   [CONVERT] 30분봉 → 일봉 변환 중...
   -> 일봉: 513,821행

   [INDUSTRY] 업종 5일 평균 상승 분석...
   [RESULT] 상승 업종: 1개

   [SECTOR] 섹터 5일 평균 상승 분석 (비율: 60%)...
   [RESULT] 상승 섹터: 4개

   [MATCH] 업종 + 섹터 동시 상승 종목 탐색...
   [RESULT] 매칭 종목: 9개

----------------------------------------------------------------------
   업종코드     업종명                       평균등락률      종목수
----------------------------------------------------------------------
   009      의   약  품                 +0.23%      44개
----------------------------------------------------------------------

--------------------------------------------------------------------------------
   종목코드     종목명                   평균등락률      업종수      섹터수
--------------------------------------------------------------------------------
   009420   한올바이오파마              +5.59%       1개       1개
   128940   한미약품                 +3.20%       1개       1개
   170900   동아에스티                +1.92%       1개       1개
   ...
--------------------------------------------------------------------------------

   [TIME] 소요 시간: 2.57초
```

#### 옵션

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `--base-date` | 기준 날짜 (YYYYMMDD) | 필수 |
| `--days` | 평균 상승 기준 일수 | 5 |
| `--ratio` | 섹터 상승 판정 비율 | 0.6 (60%) |
| `--parquet` | Parquet 파일 경로 | 자동 탐색 |

---

### 2. API 기반 분석 (기존)

> **참고**: 로컬 데이터가 없거나 최신 데이터가 필요한 경우에만 사용하세요.

```bash
cd sector_theme_analyzer

# 기본 실행 (5일 평균 상승, 테마 60% 기준)
python main.py --base-date 20251101 --days 5

# 3일 평균 상승
python main.py --base-date 20251101 --days 3

# 테마 상승 비율 70%로 변경
python main.py --base-date 20251101 --days 5 --ratio 0.7

# 업종만 분석
python main.py --base-date 20251101 --sector-only

# 테마만 분석
python main.py --base-date 20251101 --theme-only

# 상세 결과 출력
python main.py --base-date 20251101 --detail
```

#### 옵션 설명

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `--base-date` | 기준 날짜 (YYYYMMDD) | 필수 |
| `--days` | 평균 상승 기준 일수 | 5 |
| `--ratio` | 테마 상승 판정 비율 | 0.6 (60%) |
| `--sector-only` | 업종 분석만 실행 | - |
| `--theme-only` | 테마 분석만 실행 | - |
| `--detail` | 상세 결과 출력 | - |
| `--output` | 결과 저장 경로 | output/result_날짜_일수d.json |

---

## 시뮬레이션 (API 호출 없음)

분석 실행 후 저장된 캐시 데이터를 활용하여 다양한 비율로 시뮬레이션할 수 있습니다.

```bash
# 기본 60%
python simulate.py cache_20251104_3d.json

# 50%로 시뮬레이션
python simulate.py cache_20251104_3d.json --ratio 0.5

# 여러 비율 비교
python simulate.py cache_20251104_3d.json --ratio 0.3 0.4 0.5 0.6 0.7

# 10%~90% 전체 시뮬레이션
python simulate.py cache_20251104_3d.json --all
```

### 출력 예시

```
[SIMULATION] 비율별 상승 테마 수 시뮬레이션
기준일: 20251104
기간: 3거래일

    비율     상승테마수
------------------------------
    10%           45개
    20%           32개
    30%           25개
    40%           18개
    50%           12개
    60%            5개
    70%            2개
    80%            0개
    90%            0개
```

---

## OHLC 데이터 다운로드

백테스팅용 OHLC 데이터를 다운로드합니다.

```bash
# 일봉 (기본)
python download_ohlc.py

# 30분봉
python download_ohlc.py --interval 30m

# 5분봉
python download_ohlc.py --interval 5m

# 1분봉
python download_ohlc.py --interval 1m
```

### 실행 흐름

```
============================================================
   OHLC 데이터 다운로드
   (섹터가 있는 종목 일봉 데이터)
============================================================

   시작일 입력 (YYYYMMDD, 예: 20240101): 20240101
   종료일 입력 (YYYYMMDD, 예: 20241231): 20241231

------------------------------------------------------------
   데이터 타입: 일봉
   시작일: 20240101
   종료일: 20241231
   기간: 약 366일 (거래일 약 250일)
   대상 종목: 2388개 (섹터 있는 종목)
   예상 API 호출: 2388회 (1회/종목)
   예상 소요 시간: 약 46분
------------------------------------------------------------

   다운로드를 시작하시겠습니까? (y/n): y
```

### 장기간 분봉 데이터 자동 분할 조회

분봉 데이터의 경우 API 제한으로 한 번에 약 6개월치만 조회 가능합니다.
**6개월 초과 기간 요청 시 자동으로 분할 조회**합니다.

```
사용자 입력: 20230101 ~ 20251205 (약 3년)

내부 처리 (자동):
  1차: 20230101 ~ 20230630 → 조회
  2차: 20230701 ~ 20231231 → 조회
  3차: 20240101 ~ 20240630 → 조회
  4차: 20240701 ~ 20241231 → 조회
  5차: 20250101 ~ 20251205 → 조회

결과: 전체 데이터 병합 후 저장
```

사용자는 시작일/종료일만 입력하면 됩니다. 분할 조회, 중복 제거, 정렬은 자동 처리됩니다.

### 예상 소요 시간

| 간격 | 1년 기준 |
|------|----------|
| 일봉 | 약 46분 |
| 30분봉 | 약 5시간 |
| 5분봉 | 약 30시간 |
| 1분봉 | 약 6일 |

> **참고**: 분봉 데이터는 6개월 단위로 분할 조회되므로, 2년치 조회 시 4배의 시간이 소요됩니다.

### 저장 형식

- **JSON**: 백테스팅용, 메타데이터 포함
- **CSV**: 엑셀/판다스 호환

```
output/
├── ohlc_20240101_20241231_1d.json
├── ohlc_20240101_20241231_1d.csv
├── ohlc_20240101_20241231_30m.json
└── ohlc_20240101_20241231_30m.csv
```

### API 조회 가능 기간 제한

| 데이터 타입 | 최대 조회 기간 |
|-------------|----------------|
| 일봉 (t8410) | 약 2년 8개월 |
| 분봉 (t8412) | 약 1년 (240거래일) |

> **주의**: 분봉 데이터는 LS증권 서버에서 약 1년치만 보관됩니다. 그 이전 데이터는 조회할 수 없습니다.

---

## CSV → Parquet 변환

대용량 CSV 파일을 Parquet으로 변환하면 용량과 로딩 속도가 크게 개선됩니다.

### 왜 Parquet인가?

| 항목 | CSV | Parquet |
|------|-----|---------|
| 용량 | 432 MB | ~100 MB (70~80% 감소) |
| 로딩 속도 | 느림 | 5~10배 빠름 |
| 컬럼 선택 조회 | 불가 | 가능 |
| 압축 | 없음 | snappy/gzip/zstd |

### 사용법

```bash
# 단일 파일 변환
python convert_to_parquet.py ohlc_20240101_20251205_30m.csv

# 여러 파일 변환
python convert_to_parquet.py ohlc*.csv

# 모든 CSV 변환
python convert_to_parquet.py *.csv

# gzip 압축 사용 (더 작은 용량, 약간 느림)
python convert_to_parquet.py ohlc*.csv --compression gzip
```

### 옵션

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `--compression` | 압축 방식 (snappy, gzip, zstd, none) | snappy |

### 변환 결과 예시

```
============================================================
   CSV → Parquet 변환
============================================================
   대상 파일: 2개
   압축 방식: snappy

   [CONVERT] ohlc_20240101_20251205_30m.csv
   -> 읽는 중...
   -> 데이터 타입 최적화 중...
   -> Parquet 저장 중 (압축: snappy)...
   [DONE] 변환 완료!
   CSV:     432.2 MB
   Parquet: 98.5 MB (77% 감소)

============================================================
   완료: 2/2개 변환 성공
============================================================
```

### Parquet 파일 사용 (Python)

```python
import pandas as pd

# 전체 로드
df = pd.read_parquet("output/ohlc_20240101_20251205_30m.parquet")

# 특정 컬럼만 로드 (메모리 절약)
df = pd.read_parquet("output/ohlc_20240101_20251205_30m.parquet",
                     columns=["종목코드", "날짜", "시간", "종가"])

# 필터링 후 로드
df = pd.read_parquet("output/ohlc_20240101_20251205_30m.parquet",
                     filters=[("종목코드", "==", "005930")])
```

### 필요 패키지

```bash
pip install pandas pyarrow
```

---

## API 설정

`backend/.env` 파일에 LS증권 API 키 설정:

```
LS_APP_KEY=your_app_key
LS_APP_SECRET=your_app_secret
```

### API 딜레이 설정 (config.py)

```python
api_delay: float = 1.0              # 매 호출마다 1초 대기
extra_delay_interval: int = 20      # 20회마다
extra_delay: float = 3.0            # 추가 3초 대기
rate_limit_wait: float = 65.0       # Rate Limit 시 65초 대기
```

---

## 사용 API

| API | 용도 | 호출 수 |
|-----|------|--------|
| t8424 | 전체 업종 목록 | 1회 |
| t1514 | 업종 기간별 추이 | ~25회 |
| t8410 | 종목 일봉 차트 | ~2,400회 |
| t8412 | 종목 분봉 차트 | 가변 |

---

## 출력 예시

```
============================================================
   SECTOR THEME ANALYZER V3
   과거 날짜 기준 업종 + 테마 동시 상승 종목 분석
============================================================
   기준일: 20251101
   연속 상승 일수: 5일
   테마 상승 비율: 60%
============================================================

[SECTOR] 업종 5거래일 평균 상승 탐색
   -> 24개 업종 분석 중...
   [RESULT] 5거래일 평균 상승 업종: 3개

------------------------------------------------------------
   업종코드   업종명                        총등락율       평균
------------------------------------------------------------
   019    운 수 창 고                   +6.84%   +1.37%
   028    부   동  산                  +2.27%   +0.45%
   012    건 설 업                     +1.85%   +0.37%
------------------------------------------------------------

[THEME] 테마 5거래일 평균 상승 탐색 (V3)
   -> 267개 테마 분석 중...
   [RESULT] 5거래일 평균 상승 테마: 5개

[MATCH] 업종 + 테마 동시 상승 종목 탐색
   [RESULT] 업종+테마 동시 상승 종목: 12개

------------------------------------------------------------
   종목코드   종목명              등락률     업종수   테마수
------------------------------------------------------------
   005930   삼성전자            +3.25%      2      3
   000660   SK하이닉스          +2.87%      1      2
   ...
------------------------------------------------------------
```

---

## 주의사항

1. **API 호출 제한**: LS증권 API는 호출 횟수 제한이 있습니다. Rate Limit 발생 시 자동으로 대기 후 재시도합니다.

2. **소요 시간**: 전체 분석에 약 40~50분 소요됩니다. 시뮬레이션 기능을 활용하면 API 호출 없이 다양한 조건을 테스트할 수 있습니다.

3. **섹터 있는 종목만**: 분석 대상은 섹터코드가 있는 종목(약 2,400개)으로 제한됩니다.

4. **실제 거래일**: 요청한 기준일이 휴장일인 경우, 가장 최근 거래일 기준으로 데이터가 조회됩니다.

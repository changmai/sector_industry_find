@echo off
chcp 65001 >nul
setlocal EnableDelayedExpansion

REM ================================================================================
REM   [전체 조건 TP/SL 최적화 테스트]
REM ================================================================================
REM   목적: 15개 조건의 2~3개 조합에 대해 TP/SL 최적화 수행
REM
REM   테스트 조건 (15개):
REM     - 기본: A(섹터상승), B(신고거래대금), D(정배열), E(신고가), F(거래량급증), G(회전율), H(눌림목), I(급등조정)
REM     - GT: GT_A(MACD), GT_B(RSI매수), GT_C(RSI과매수X), GT_D(지지선반등), GT_D2(변동성축소), GT_E(이평수렴), GT_F(거래량돌파)
REM
REM   예상 소요시간: 약 8~12시간 (워커 16개, step 1.5 기준)
REM   예상 테스트 수: 560개 조합 × 21개 TP/SL = 11,760개
REM ================================================================================

REM ================================================================================
REM   [1] 테스트 조건 설정
REM ================================================================================

REM 테스트할 조건 목록 (콤마 구분, 공백 없이)
set CONDITIONS=A,B,D,E,F,G,H,I,GT_A,GT_B,GT_C,GT_D,GT_D2,GT_E,GT_F

REM ================================================================================
REM   [2] 백테스트 기간 설정
REM ================================================================================

REM 시작일 (YYYYMMDD 형식)
set START_DATE=20250101

REM 종료일 (YYYYMMDD 형식)
set END_DATE=20250630

REM ================================================================================
REM   [3] TP/SL 최적화 범위 설정
REM ================================================================================

REM 익절선 범위 (%)
set TP_MIN=10
set TP_MAX=15

REM 손절선 범위 (%, 음수)
set SL_MIN=-7
set SL_MAX=-3

REM 최적화 스텝 (%)
REM   1.0 = 세밀한 탐색 (시간 오래 걸림)
REM   1.5 = 적정 탐색 (권장)
REM   2.0 = 빠른 탐색
set STEP=1.5

REM ================================================================================
REM   [4] 조합 및 필터 설정
REM ================================================================================

REM 최소 조합 크기 (2 = 조건 2개 AND 조합부터)
set MIN_SIZE=2

REM 최대 조합 크기 (3 = 조건 3개 AND 조합까지)
set MAX_SIZE=3

REM 최소 거래 건수 (이하면 무효 처리)
set MIN_TRADES=50

REM 최대 보유일
set MAX_HOLDING=14

REM ================================================================================
REM   [5] 트레일링스탑 설정
REM ================================================================================

REM 트레일링 시작 수익률 (%)
REM   5 = 5% 수익 도달 시 트레일링 시작
set TRAILING_START=5

REM 고점 대비 하락 허용폭 (%)
REM   3 = 고점에서 3% 하락 시 청산
set TRAILING_OFFSET=3

REM ================================================================================
REM   [6] 출력 및 병렬 처리 설정
REM ================================================================================

REM 정렬 기준 (avg_return: 평균수익률, win_rate: 승률)
set SORT_BY=avg_return

REM 상위 N개 결과 출력
set TOP_N=20

REM 로그 파일 저장 여부 (1=저장, 0=미저장)
set SAVE_LOG=1

REM 병렬 워커 수
REM   권장: 6~16 (메모리 상황에 따라 조절)
REM   CPU 코어의 50~70% 정도가 적당
set WORKERS=16

REM ================================================================================
REM ================================================================================
REM   [실행부] - 아래 코드는 수정하지 마세요
REM ================================================================================
REM ================================================================================

cd /d "%~dp0.."

echo.
echo ================================================================================
echo   [전체 조건 TP/SL 최적화 테스트]
echo ================================================================================
echo   조건: %CONDITIONS%
echo   기간: %START_DATE% ~ %END_DATE%
echo   TP 범위: %TP_MIN%%% ~ %TP_MAX%%% (step: %STEP%)
echo   SL 범위: %SL_MIN%%% ~ %SL_MAX%%% (step: %STEP%)
echo   조합 크기: %MIN_SIZE% ~ %MAX_SIZE%개
echo   트레일링: +%TRAILING_START%%% 시작, -%TRAILING_OFFSET%%% 청산
echo   워커: %WORKERS%개
echo ================================================================================
echo.

REM 명령어 구성
set CMD=python combination_tester.py
set CMD=%CMD% --conditions %CONDITIONS%
set CMD=%CMD% --start-date %START_DATE% --end-date %END_DATE%
set CMD=%CMD% --min-size %MIN_SIZE% --max-size %MAX_SIZE%
set CMD=%CMD% --min-trades %MIN_TRADES%
set CMD=%CMD% --max-holding %MAX_HOLDING%
set CMD=%CMD% --sort-by %SORT_BY% --top %TOP_N%
set CMD=%CMD% --trailing-start %TRAILING_START% --trailing-offset %TRAILING_OFFSET%
set CMD=%CMD% --optimize
set CMD=%CMD% --tp-min %TP_MIN% --tp-max %TP_MAX%
set CMD=%CMD% --sl-min %SL_MIN% --sl-max %SL_MAX%
set CMD=%CMD% --step %STEP%
set CMD=%CMD% --workers %WORKERS%

if "%SAVE_LOG%"=="1" (
    set CMD=!CMD! --log
)

echo [실행 명령어]
echo %CMD%
echo.

REM 실행
%CMD%

echo.
echo ================================================================================
echo   실행 완료
echo ================================================================================

pause

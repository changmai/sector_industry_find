# 비차익 프로그램 매수 시그널 감지 로직

## 개요

이 문서는 **비차익 프로그램 매수 급증 이벤트**를 감지하는 로직을 설명합니다.

---

## 1. 데이터 소스

### LS증권 UPH (통합프로그램매매종목별) 실시간 데이터

| 필드명 | 설명 | 단위 |
|--------|------|------|
| `bshvolume` | 비차익매수체결수량 (누적) | 주 |
| `sshvolume` | 비차익매도체결수량 (누적) | 주 |
| `bshrem` | 비차익매수호가잔량 | 주 |
| `bdhrem` | 비차익매도호가잔량 | 주 |
| `price` | 현재가 | 원 |
| `tval` | 전체순매수금액 | 원 |

> **비차익거래**: 선물/현물 간 차익을 노리지 않는 순수한 방향성 매매. 기관/외국인의 적극적인 매수 의지를 반영.
>
> **체결수량 vs 호가잔량**: `bshvolume`은 실제 체결된 수량의 누적값이고, `bshrem`은 대기 중인 호가잔량입니다.

---

## 2. 시그널 감지 조건

### 핵심 공식

```
Delta = 현재_bshvolume - 이전_bshvolume
추정금액 = Delta × 현재가

IF 추정금액 >= 임계값(3천만원) THEN 이벤트 발생
```

### 조건 설명

| 조건 | 설명 |
|------|------|
| `Delta > 0` | 비차익 매수체결수량이 증가해야 함 (매수 체결 발생) |
| `추정금액 >= 3천만원` | 노이즈 필터링 - 의미 있는 크기의 자금만 포착 |

---

## 3. 왜 이렇게 계산하는가?

### 3.1 Delta(변동량)를 사용하는 이유

- **절대값이 아닌 변화량**이 중요
- "현재 얼마나 보유 중인가"가 아니라 **"지금 얼마나 새로 들어왔는가"**를 봄
- 급격한 매수 유입 = 기관/외국인의 적극적인 매수 신호

### 3.2 금액 환산하는 이유

```
같은 500주라도:
- 삼성전자(8만원) × 500주 = 4천만원 ← 의미 있음
- 저가주(1천원) × 500주 = 50만원 ← 노이즈
```

**수량만으로는 종목 간 비교가 불가능**하므로, 금액으로 환산하여 동일한 기준 적용.

### 3.3 임계값(3천만원)의 의미

- 너무 낮으면: 노이즈가 많아짐
- 너무 높으면: 실제 시그널을 놓침
- **3천만원**: 중형주 기준 적정 수준 (조정 가능)

```
권장 임계값:
- 대형주 (삼성전자 등): 5천만원 ~ 1억원
- 중형주: 3천만원
- 소형주: 1천만원
```

---

## 4. 이벤트 발생 시 기록 데이터

| 필드 | 설명 | 예시 |
|------|------|------|
| `event_time` | 이벤트 발생 시각 | 2024-01-15 09:32:15 |
| `code` | 종목코드 | 005930 |
| `event_type` | 이벤트 유형 | buy_surge |
| `delta_vol` | 변동 수량 | 500 |
| `trigger_value` | 추정 금액 | 40,000,000 |
| `price_at_event` | 이벤트 시점 가격 | 80,000 |

---

## 5. 이벤트 후 가격 추적

이벤트 발생 후 **1분, 5분, 10분, 30분** 후의 가격을 추적하여 수익률 계산:

```
수익률(%) = (추적시점_가격 - 이벤트시점_가격) / 이벤트시점_가격 × 100
```

### 승률 계산

- **매수 급증(buy_surge)**: 가격 상승 시 승리
- **매도 급증(sell_surge)**: 가격 하락 시 승리

---

## 6. 흐름도

```
[LS증권 WebSocket]
       │
       ▼
[UPH 데이터 수신] ─────────────────────────────┐
       │                                        │
       ▼                                        │
[이전 데이터와 비교]                             │
       │                                        │
       ▼                                        │
  Delta 계산                                    │
  (현재 bshvolume - 이전 bshvolume)             │
       │                                        │
       ▼                                        │
  추정금액 계산                                  │
  (Delta × 현재가)                              │
       │                                        │
       ▼                                        │
┌──────────────────┐                           │
│ 추정금액 >= 3천만원? │                          │
└──────────────────┘                           │
       │                                        │
   YES │    NO                                  │
       ▼     └──────────────────────────────────┘
[이벤트 기록]
       │
       ▼
[가격 추적 시작]
(1분, 5분, 10분, 30분 후)
       │
       ▼
[수익률 계산 및 저장]
```

---

## 7. 한계점 및 주의사항

### 7.1 데이터 정확성

- `bshvolume`은 **실제 체결된 수량의 누적값**이므로 신뢰도가 높음
- 단, 대량 체결이 여러 틱에 걸쳐 나뉘어 들어올 수 있음
- 체결 시점과 데이터 수신 시점 사이에 약간의 지연 존재 가능

### 7.2 시장 상황 의존성

- 장 초반/후반 변동성이 클 때 노이즈 증가
- 특정 이벤트(공시, 뉴스) 시 비정상적 패턴 발생 가능

### 7.3 임계값 최적화

- 종목별, 시장 상황별로 최적의 임계값이 다름
- 백테스트를 통해 지속적인 최적화 필요

---

## 8. 관련 파일

| 파일 | 역할 |
|------|------|
| `event_detector.py` | 이벤트 감지 로직 |
| `price_tracker.py` | 가격 추적 모듈 |
| `research_db.py` | 데이터베이스 저장/조회 |
| `report_generator.py` | 리포트 생성 |

---

## 9. API 엔드포인트

| 엔드포인트 | 설명 |
|------------|------|
| `GET /api/research/events` | 이벤트 목록 조회 |
| `GET /api/research/events/{id}` | 이벤트 상세 조회 |
| `GET /api/research/live` | 실시간 대시보드 데이터 |
| `POST /api/research/config?threshold_value=N` | 임계값 변경 |

---

## 10. 요약

```
비차익 매수체결수량이 한 번에 3천만원 이상 증가하면
→ "기관/외국인의 적극적 매수 유입" 시그널로 판단
→ 이벤트 기록 및 이후 가격 추적
```
